<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram ç”¨æˆ·åå°ç®¡ç†</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
async function saveUser(userId) {
  const blocked = document.getElementById('blocked-' + userId).value;
  const points = document.getElementById('points-' + userId).value;
  const plays = document.getElementById('plays-' + userId).value;
  await fetch(`/user/save`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: userId, blocked, points, plays })
  });
  alert('âœ… å·²ä¿å­˜');
}

    async function deleteUser(userId) {
      if (!confirm('ç¡®è®¤åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿ')) return;
      await fetch(`/user/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId })
      });
      location.reload();
    }
  </script>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-4">Telegram ç”¨æˆ·åå°ç®¡ç†</h2>
<form class="input-group mb-3" method="get" action="/admin">
  <input type="text" class="form-control" name="q" placeholder="ç”¨æˆ·å / æ‰‹æœºå· / é‚€è¯·äººç”¨æˆ·å" value="{{ request.args.q or '' }}">
  <select class="form-select" name="filter" style="max-width:150px">
    <option value="">å…¨éƒ¨</option>
  </select>
  <button class="btn btn-primary" type="submit">æœç´¢</button>
</form>
  <div class="mb-3">
  <a href="/admin" class="btn btn-sm btn-secondary">ğŸ” åˆ·æ–°</a>
  <a href="/admin/rank/today" class="btn btn-sm btn-primary">ğŸ“ˆ ä»Šæ—¥æ’è¡Œæ¦œ</a>
  <a href="/init" class="btn btn-sm btn-warning">âš™ï¸ åˆå§‹åŒ–è¡¨ç»“æ„</a>
</div>  

    <div class="alert alert-info">
      æ€»ç”¨æˆ·æ•°: {{ stats.total }} ï½œå·²æˆæƒæ‰‹æœºå·: {{ stats.verified }} ï½œå·²å°ç¦ç”¨æˆ·: {{ stats.blocked }} ï½œæ€»ç§¯åˆ†: {{ stats.points }}
    </div>

    <table class="table table-bordered table-striped">
      <thead class="table-dark">
        <tr>
          <th>ç”¨æˆ·ID</th><th>ç”¨æˆ·å</th><th>æ‰‹æœºå·</th><th>ç§¯åˆ†</th>
          <th>ä»Šæ—¥æ¸¸æˆæ¬¡æ•°</th><th>é‚€è¯·äºº</th><th>å·²é‚€è¯·</th><th>å°ç¦çŠ¶æ€</th>
          <th>æ³¨å†Œæ—¶é—´</th><th>æœ€åæ¸¸æˆæ—¶é—´</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ user.user_id }}</td>
          <td>{{ user.username }}</td>
          <td>{{ user.phone or 'æœªæˆæƒ' }}</td>
          <td>
            <input type="number" id="points-{{ user.user_id }}" value="{{ user.points or 0 }}" class="form-control form-control-sm">
          </td>
          <td>
            <input type="number" id="plays-{{ user.user_id }}" value="{{ user.plays or 0 }}" class="form-control form-control-sm">
          </td>
          <td>{{ user.inviter or 'æ— ' }}</td>
          <td>
            å·²é‚€è¯· {{ user.invited_count }} äºº
            {% if (user.invited_count or 0) > 0 %}
              <a class="btn btn-sm btn-primary" href="/invitees?user_id={{ user.user_id }}">æŸ¥çœ‹é‚€è¯·ç”¨æˆ·</a>
            {% endif %}
          </td>
          <td>
            <select id="blocked-{{ user.user_id }}" class="form-select form-select-sm">
              <option value="0">å¦</option>
              <option value="1">æ˜¯</option>
            </select>
          </td>
          <td>{{ user.created_at or '' }}</td>
          <td>{{ user.last_game_time or 'æ— ' }}</td>
          <td>
            <button class="btn btn-success btn-sm" onclick="saveUser('{{ user.user_id }}')">ä¿å­˜</button>
            <button class="btn btn-danger btn-sm" onclick="deleteUser('{{ user.user_id }}')">åˆ é™¤</button>
            <a class="btn btn-info btn-sm mt-1" href="/user/logs?user_id={{ user.user_id }}">æŸ¥çœ‹æ¸¸æˆè®°å½•</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <nav aria-label="åˆ†é¡µå¯¼èˆª">
    <ul class="pagination justify-content-center mt-4">
    {% if page > 1 %}
    <li class="page-item">
      <a class="page-link" href="/admin?q={{ keyword }}&page={{ page - 1 }}">ä¸Šä¸€é¡µ</a>
    </li>
    {% endif %}
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="/admin?q={{ keyword }}&page={{ p }}">{{ p }}</a>
    </li>
    {% endfor %}
    {% if page < total_pages %}
    <li class="page-item">
      <a class="page-link" href="/admin?q={{ keyword }}&page={{ page + 1 }}">ä¸‹ä¸€é¡µ</a>
    </li>
    {% endif %}
  </ul>
</nav>
</body>
</html>
